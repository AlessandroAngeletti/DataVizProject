---
title: "Session 7 Clustering Workshop"
author: "Group 13 - Alessandro Angeletti, Zichen Wang, Johanna Jeffery, Nitya Chopra and Christopher Lewis"
date: "`r Sys.Date()`"
output: 
    html_document:
      number_sections: true
      highlight: haddock
      theme: spacelab
      toc: yes
      toc_depth: 2
      toc_float:
        collapsed: false
      fontzize: 10 pt
---

```{r, setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
# Load the relevant libraries
library(tidyverse)
library(lubridate)
library(mice) 
library(VIM)
library(dplyr)
library(Hmisc)
library(janitor)
library(readxl)
library(skimr)
library(ggridges)
library(ggplot2)
library(tm)
library(wordcloud)
library(caret)
library(rsample)
library(GGally)
```

# Background

why are we visualizing this dataset? what do we want to get out of it?

# Load & inspect Data

We would like to inspect the dataset in the following orders:

1) missing, empty, and duplicated values;
1) data types;
1) weird values, errors, and outliers.

```{r}
# 1. Load the data
original_data <- vroom::vroom("winemag-data-130k-v2.csv") %>% 
  clean_names() %>% 
  select(-x1) # Discard an irrelevant column

# Take a look at the raw data
head(original_data)

# Check for missing values
describe(original_data) 

# Check for duplicates
get_dupes(original_data)

# Check data types
glimpse(original_data)

# Check for errors and outliers
ggplot(original_data, aes(x = price)) +
  geom_boxplot()
ggplot(original_data, aes(x = price)) +
  geom_histogram(binwidth = 20)
ggplot(original_data, aes(x = points)) +
  geom_boxplot()
```

Through the inspection, we find:

> *Missing, empty, and duplicated values:*

- `country`: 63 blanks, why missing? should we fix it or not? how to fix it?
- `designation`: 
- `region_1`:
- `region_2`:
- `taster_name`:
- `taster_twitter_handle`:
- `variety`: 1 blank, 

> *data type:*

- `country`: should be a catergorical variable.
- 

> *weird values, errors, and outliers:*

- `price` appears to have an outlier.
- `points` falls in a reasonal range between 80 and 100, which does not need to be further modified.

## Clean data

This section will follow the order of the previous section and aim to fix the flaws to ease the further visualization.

### Resolve the missing values 

```{r, clean data 1}
# While trying to fix the missing countries with another locator
# We find that all observations missing country values have unique winery values
# List of all wineries for entries with no country.
wineries_na_country <- original_data %>% 
  filter(is.na(country)) %>% 
  summarise(winery) %>% 
  distinct()

# As some of the wineries in the above list have countries in other entries
# We can use the above list to fill the missing countries with the same wineries
# And the missing countries to the remaining incomparable wineries will be manually searched
wineries_countrymatch <- inner_join(original_data, wineries_na_country, by = "winery") %>%
  group_by(winery, country) %>% 
  summarise(country, winery) %>% 
  distinct()

# Load the manually completed list of countries with wineries
wineries_countryfinal <- read.csv("Winery_Country_List.csv", header = TRUE)

# Create a copy of the raw data to clean
clean1 <- original_data

# Fill the missing countries with our final list by wineries 
clean1$country[is.na(clean1$country)] <- wineries_countryfinal$country[match(clean1$winery, wineries_countryfinal$winery)][which(is.na(clean1$country))]

# Check the new status of missing values
skim(clean1$country)

# Find out the one missing value in variety(grape type)
variety_na <- clean1 %>% 
  filter(is.na(variety))

# While the other information for this observation is incomparable
# We find a trace of grape type in the description
# The missing grape type is "Petite Sirah"
clean1 <- clean1 %>% 
  mutate(variety = case_when(title == "Carmen 1999  (Maipo Valley)" ~ "Petite Sirah",
                            TRUE ~ variety 
                            ),
         region_1 = case_when(province == "Douro" ~ "Tr√°s-os-Montes",
                              TRUE ~ region_2)
         )

skim(clean1$variety)

clean2 <- clean1 %>% 
  select(-c(region_2, taster_twitter_handle)) %>% 
  filter(
    !is.na(price),
    !is.na(points),
    !is.na(country)
  ) %>% 
  mutate(
    company = str_extract(title, '\\D*(?=\\d)'),
    year = as.double(trimws(gsub("[^0-9]", "",  title))),
    year = case_when(
      year < 1934 ~ 0,
      year > 2020 ~ 0,
      TRUE ~ year
      )
     # Missing the info after the numbers
    )

#View(clean2)
#describe(clean2)
```

### Cleaning Description

```{r}
input_words <- clean2$description[clean2$country == "France"]

input_words <- VectorSource(input_words)
input_words <- VCorpus(input_words)

irrelevant_words <- c("wine", "winery", "it", "green", "winemaking", "winemark", "without", "alcohol", "although", "across", "age", "almost", "along", "also", "amount", "alongsid", "anoth", "approach", "around", "back", "background", "basic", "barrel", "big", "bit", "blend", "bottl", "bouquet", "cellar", "continu", "core", "cut", "develop", "display", "end", "extra",  "drink", "drinking", "doesnt", "element", "enough", "featur", "feel", "fill", "find", "first", "final", "finish", "focus", "follow", "food", "forward", "frame", "front", "get", "give", "given", "glass", "grape", "here", "hint", "highlight", "hold", "just", "keep", "lack", "last", "layer", "length", "lift", "littl", "made", "make", "mark", "medium", "mix", "month", "mouth", "much", "name", "need", "new", "next", "nose", "note", "now", "offer", "one", "open", "overal", "pair", "part", "pack", "play", "price", "produc", "provid", "quick", "quit", "palat", "rather", "region",  "remain", "result", "reveal", "right", "round", "run", "select", "seem", "set", "show", "soon", "side", "sip", "small", "slight", "somewhat", "start", "suggest", "suppl", "support", "take", "that", "there", "though", "time", "togeth", "top", "toward", "two", "turn", "use", "variety", "vine", "vineyard", "vintag", "way", "weight", "will", "winemak", "wineri", "year", "yet", "<e2><80><93>", "<c3><a8>dr", "<c3><a9>" ,"aroma", "flavor", "autolyt", "serious", "reson", "long", "red", "black")

clean_words <- function(inside){
  inside <- tm_map(inside, removePunctuation)
  inside <- tm_map(inside, removeNumbers)
  inside <- tm_map(inside, content_transformer(tolower))
  inside <- tm_map(inside, removeWords, stopwords("en"))
  inside <- tm_map(inside, stemDocument)
  inside <- tm_map(inside, removeWords, irrelevant_words)
  inside <- tm_map(inside, stripWhitespace)
  return(inside)
}

out_clean_words <- clean_words(input_words)

ocw_tdm <- TermDocumentMatrix(out_clean_words)

top_10_words <- findFreqTerms(ocw_tdm, lowfreq = 3300)
paste0("The Top 10 Words Associated to Wines in ", "France" , " are: ")
print(top_10_words)

ocw_m <- as.matrix(ocw_tdm) 
aa <- rowSums(ocw_m)
aa <- sort(aa, decreasing = TRUE)

aa_df <- data.frame(words = names(aa),
                    freq = aa)

word_cloud <- aa_df %>%
  ggplot(aes(x = factor(words, levels = words[order(-freq)]), y = freq)) +
  wordcloud(aa_df$words, aa_df$freq, max.words = 10, color = "red")
```

## Exploratory Data Analysis

```{r}
# Scaled Histogram of prices
points_hist <- clean2 %>% 
  ggplot() +
  geom_histogram(aes(x = points))

points_hist

# Scaled Distribution of prices
price_hist <- clean2 %>% 
  filter(price < 85) %>% 
  ggplot() +
  geom_histogram(aes(x = price))

price_hist

# Scatter plot of Price v Points
price_points <- clean2 %>% 
  filter(price < 155) %>% 
  ggplot(aes(x = (price), y = (points))) +
  geom_point() + 
  geom_smooth(method = lm)

price_points

ReviewData <- clean2 %>% 
  group_by(country) %>% 
  summarise(tot = n()) %>% 
  arrange(desc(tot)) %>% 
  mutate(percent_of_reviews = round(tot / sum(tot), digits = 4),
         cumsum_reviews = cumsum(percent_of_reviews))

ReviewData

dist_plot <- ReviewData %>% 
  head(5) %>%
  mutate(country = as_factor(country)) %>% 
  ggplot(aes(x = country, y = tot)) +
  geom_col(stat = "identity", fill = "#524c84") + 
  geom_text(aes(label = sprintf("%.0f%%", 100 * percent_of_reviews), y = tot + 2000)) +
  labs(x = "",
       y = "Total Number of Reviews",
       title = "US Wines Dominate Dataset!",
       subtitle = "Distribution of Wine Reviews by Top 5 Countries") +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(face = "italic", size = 12)
  )

dist_plot

avg_score <- clean2 %>% 
  group_by(country) %>%
  summarise(
    avg_score = mean(points),
    count = n()
  ) %>%
  #filter(count > 50) %>% 
  arrange(desc(avg_score)) %>%
  head(10)

avg_score_plot <- avg_score %>% 
  ggplot(aes(x = reorder(country, -avg_score), y = avg_score)) + 
  geom_bar(stat = "identity", fill = "#524c84") + 
  coord_cartesian(ylim = c(88, 92)) + 
  labs(
    y = "Average Rating",
    x = "",
    title = "England Has The Highest Average Rated Wines!",
    subtitle = "Top 10 Countries by Average Rating"
    ) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(face = "italic", size = 12)
  )

avg_score_plot

select_c <- c("Engalnd",
              "Austria",
              "Germany",
              "Canada",
              "Hungary",
              "France",
              "Italy",
              "Australia",
              "US",
              "Israel")

violin_plot <- clean2 %>% 
  group_by(country) %>%
  filter(country %in% select_c) %>%
  ggplot(aes(x = points,
             y = country,
             fill = country)) +
  geom_density_ridges() +
  theme_ridges() + 
  theme(legend.position = "none")

violin_plot

score_by_country <- clean2 %>% 
  filter(country %in% select_c) %>% 
  ggplot(aes(x = points, y = reorder(country, points, FUN = median))) +
  geom_boxplot() +
  stat_summary(geom = "point",
               color = "red") +
  labs(
    y = "",
    x = "Points",
    title = "Germany has the Highest Median Score!",
    subtitle = "Distribution of Scores by Country"
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(face = "italic", size = 12)
  )
  
score_by_country

avg_price_all <- clean2 %>% 
  group_by(country) %>%
  summarise(
    avg_price = mean(price),
    count = n()
  ) %>%
  filter(count > 50) %>% 
  arrange(desc(avg_price))

select_p <- c("England",
              "US",
              "Canada",
              "Italy",
              "Lebanon",
              "Israel",
              "Hungary",
              "Germany",
              "Austria",
              "France"
              )

price_by_country <- clean2 %>% 
  filter(price < 155) %>% 
  group_by(country) %>% 
  filter(country %in% select_p) %>% 
  ggplot(aes(x = price, y = reorder(country, price, FUN = mean), color = country)) +
  geom_violin() +
  stat_summary(geom = "point",
               color = "red") +
  labs(
    y = "",
    x = "Price",
    title = "England has the Most Expensive Mean Wine!",
    subtitle = "Distribution of Prices Country"
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(face = "italic", size = 12)
  )
  
price_by_country

df <- clean2 %>% 
  filter(!is.na(price))%>% 
  select(price) %>%  
  table()
df1 <- prop.table(df) 

paste0("Portion of wines under $155: ", round(cumsum(df1)['155'] * 100, 0), "%")
```

# GGally

```{r}
clean2 %>% 
  mutate(country_num = case_when(
    country == "Portugal" ~ 1,
    country == "US" ~ 2,
    country == "Spain" ~ 3,
    country == "Italy" ~ 4,
    country == "France" ~ 5,
    country == "Germany" ~ 6,
    country == "Argentina" ~ 7,
    country == "Chile" ~ 8,
    country == "Australia" ~ 9,
    country == "Austria" ~ 10,
    country == "South Africa" ~ 11,
    country == "New Zealand" ~ 12,
    country == "Israel" ~ 13,
    country == "Hungary" ~ 14,
    country == "Greece" ~ 15,
    country == "Romania" ~ 16,
    country == "Mexico" ~ 17,
    country == "Canada" ~ 18,
    country == "Turkey" ~ 19,
    country == "Czech Republic" ~ 20,
    country == "Slovenia" ~ 21,
    country == "Luxembourg" ~ 22,
    country == "Croatia" ~ 23,
    country == "Georgia" ~ 24,
    country == "Uruguay" ~ 25,
    country == "England" ~ 26,
    country == "Lebanon" ~ 27,
    country == "Serbia" ~ 28,
    country == "Brazil" ~ 29,
    country == "Moldova" ~ 30,
    country == "Morocco" ~ 31,
    country == "Peru" ~ 32,
    country == "India" ~ 33,
    country == "Bulgaria" ~ 34,
    country == "Cyprus" ~ 35,
    country == "Armenia" ~ 36,
    country == "Switzerland" ~ 37,
    country == "Bosnia and Herzegovina" ~ 38,
    country == "Ukraine" ~ 39,
    country == "Slovakia" ~ 40,
    country == "Macedonia" ~ 41,
    TRUE ~ 42
  ),
  taster_num = case_when(
     taster_name == "Roger Voss" ~ 1,
     taster_name == "Paul Gregutt" ~ 2,
     taster_name == "Alexander Peartree" ~ 3,
     taster_name == "Michael Schachner" ~ 4,
     taster_name == "Kerin O‚ÄôKeefe" ~ 5,
     taster_name == "Anna Lee C. Iijima" ~ 6,
     taster_name == "Virginie Boone" ~ 7,
     taster_name == "Matt Kettmann" ~ 8,
     taster_name == "Sean P. Sullivan" ~ 9,
     taster_name == "Jim Gordon" ~ 10,
     taster_name == "Joe Czerwinski" ~ 11,
     taster_name == "Anne Krebiehl MW" ~ 12,
     taster_name == "Lauren Buzzeo" ~ 13,
     taster_name == "Mike DeSimone" ~ 14,
     taster_name == "Jeff Jenssen" ~ 15,
     taster_name == "Susan Kostrzewa" ~ 16,
     taster_name == "Carrie Dykes"  ~ 17,
     taster_name == "Fiona Adams" ~ 18,
     taster_name == "Christina Pickard" ~ 19,
     TRUE ~ 20
  )) %>% 
  select(c(price, points, year, country_num, taster_num)) %>% #keep Y variable last
  filter(year > 0) %>%
  ggcorr(method = c("pairwise", "pearson"), label_round = 2, nbreaks = 5, label = TRUE)

describe(clean2)
unique(clean2$taster_name)
```


# Regression - Scores

## OLS

```{r}
dataAnalysis <- clean2 %>% 
  filter(price < 156,
         country %in% c("Spain", "Italy", "Portugal", "US"),
         year > 0
         ) %>% 
  mutate(
    points = as.integer(points),
    price = as.integer(price),
    winery = as.factor(winery),
    province = as.factor(province),
    variety = as.factor(variety),
    taster_name = as.factor(taster_name)
  )

ols_model <- lm(points ~ price, dataAnalysis)
summary(ols_model)

# R-Squared of: 0.2815

ols_model2 <- lm(points ~ price + log(price), dataAnalysis)
summary(ols_model2)

# R-Squared of: 0.3268 

anova(ols_model, ols_model2)
# Our model improved as the p-value (2.2e-16) is far below alpha

ols_model3 <- lm(points ~ price + log(price) + country, dataAnalysis)
summary(ols_model3)

# R-Squared of: 0.3381

ols_model4 <- lm(points ~ price + log(price) + country + year, dataAnalysis)
summary(ols_model4)
ols_model4b <- lm(points ~ log(price) + country + year, dataAnalysis)
summary(ols_model4b)

# R-Squared of: 0.3437
# R-Squared of: 0.3519

ols_model5 <- lm(points ~ log(price) + country + year + taster_name, dataAnalysis)
summary(ols_model5)

# R-Squared of: 0.3779 

ols_model6 <- lm(points ~ price + log(price) + country + year + variety, dataAnalysis)
summary(ols_model6)

# R-squared of: 0.3734

ols_model6b <- lm(points ~ price + log(price) + country + year*variety, dataAnalysis)
summary(ols_model6b)

# R-squared of: 0.3787

ols_model7 <- lm(points ~ price + log(price) + country + year + province, dataAnalysis)
summary(ols_model7)

# R-squared of: 0.3714 

ols_model8 <- lm(points ~ price + log(price) + country + year*province, dataAnalysis)
summary(ols_model8)

# R-squared of: 0.3797 

ols_model8 <- lm(points ~ price + log(price) + country + year*province + year*variety, dataAnalysis)
summary(ols_model8)

# R-squared of: 0.4020 

ols_model9 <- lm(points ~ log(price) + country + year*province + year*variety, dataAnalysis)
summary(ols_model9)
# R-squared of: 0.4019

anova(ols_model, ols_model2, ols_model3, ols_model4)
# Our model improved as the p-value (2.2e-16) is far below alpha
```

## K-Fold

```{r}
control <- trainControl (
    method = "cv",
    number = 5,
    verboseIter = TRUE) #by setting this to true the model will report its progress after each estimation

#we are going to train the model and report the results using k-fold cross validation
plsFit <- train(
  points ~ log(price) + country + year*province + year*variety,
  dataAnalysis,
  method = "lm",
  trControl = control
  )

print(plsFit)
```

## LASSO

```{r}
set.seed(1234)
lambda_seq <- seq(0, 0.01, length = 1000)
train_test_split <- initial_split(dataAnalysis, prop = 0.01)
training <- training(train_test_split)
testing <- testing(train_test_split)

lasso <- train(
 points ~ price + log(price) + country + year,
 data = training,
 method = "glmnet",
  preProc = c("center", "scale"), # This option standardizes the data before running the LASSO regression
  trControl = control,
  tuneGrid = expand.grid(alpha = 1, lambda = lambda_seq) # Alpha=1 specifies to run a LASSO regression. If alpha=0 the model would run ridge regression.
  )

coef(lasso$finalModel, lasso$bestTune$lambda)
lasso$bestTune$lambda

predictions <- predict(lasso,testing)

# Model prediction performance
data.frame(
  RMSE = RMSE(predictions, testing$points),
  Rsquare = R2(predictions, testing$points)
)

```{r}
# We can check variable importance as well
importance7 <- varImp(model_lm, scale = TRUE)
plot(importance7)
```